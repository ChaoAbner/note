# 字节码（Class）文件的结构

根据《Java虚拟机规范》的规定，CIass文件格式采用一种类似于c语言结构体的伪结构来存储数据，这种伪结构中只有两种数据类型：**“无符号数“和“表''**。后面的解析都要以这两种数据类型为基础。

无符号数属于基本的数据类型，以ul、u2、u4、u8来分别代表1个字节、2个字节、4个字节和8个字节的无符号数，无符号数可以用来描述数字、索引引用、数量值或者按照UTF-8编码构成字符串值。

![image-20200724152006685](http://img.fosuchao.com/image-20200724152006685.png)

## 魔术magic与Class文件的版本

每个CIass文件的头4个字节被称为魔数(Magic Number)，它的**唯一作用是确定这个文件是否为一个能被虚拟机接受的class文件**。

紧接着魔数的4个字节存储的是CIass文件的版本号：第5和第6个字节是次版本号(Minor），第7和第8个字节是主版本号(Major)。Java的版本号是从45开始的，JDK1.1之后的每个JDK大版本发布主版本号向上加1（JDK1.0~JDK1.1使用了45.0~45.3的版本号）。

高版本的JDK能向下兼容以前版本的CIass文件，但不能运行以后版本的CIass文件，因为《Java虚拟机规范》在CIass文件校验部分明确要求了即使文件格式并未发生任何变化，虚拟机也必须拒绝执行超过其版本号的CIass文件。

class文件结构：

![image-20200724152931399](http://img.fosuchao.com/image-20200724152931399.png)

上图的前四个字节是0XCAFEBABE作为魔术进行校验。后面的5，6字节是0，7，8字节可以知道目前的版本号是0X32，转成十进制就是50。

## 常量池

紧接着版本号的就是常量池入口。

常量池结构：

![image-20200724153311724](http://img.fosuchao.com/image-20200724153311724.png)

常量池中主要存放两大类常量，字面量和符号引用。字面量比较接近于Java语言层面的常量概念，如文本字符串、被声明为final的常量值等。而符号引用则属于编译原理方面的概念，主要包括下面几类常量：

- 被模块导出或者开放的包（Package）
- 类和接口的全限全名（Fully Qualified Name）
- 字段的名称和描述符（Descriptor）
- 方法的名称和描述符
- 方法句柄和方法类型（methods Handle，Method Type）
- 动态调用点和动态常量

## 访问标志

在常量池结束之后，紧接着的2个字节代表访问标志（access flags），这个标志用于识别一些类或者接口层次的访问信息，包括：**这个CIass是类还是接口；是否定义为public类型，是否定义为abstract类型**；**如果是类的话，是否被声明为final等等。**

## 类索引、父类索引与接口索引集合

类索引（this class)和父类索引(supe rclass)都是一个u2类型的数据，而接口索引集合（interfaces）是一组u2类型的数据的集合，CIass文件中由这三项数据来确定该类型的继承关系。

类索引用于确定这个类的全限定名，父类索引用于确定这个类的父类的全限定名。由于Java语言不允许多重继承，所以父类索引只有一个，除了`java.lang.0bject`之外，所有的Java类都有父类，因此除了
`Java.lang.0bject`外，所有Java类的父类索引都不为0。

接口索引集合就用来描述这个类实现了哪些接口，这些被实现的接口将按inplements关键字（如果这个CIass文件表示的是一个接口，则应当是extends关键字）后的接口顺序从左到右排列在接口索引集合中。

## 字段表集合

字段表（field_info)用于描述接口或者类中声明的变量。Java语言中的“字段''(FieId)包括类级变量以及实例级变量，但不包括在方法内部声明的局部变量。

读者可以回忆一下在Java语言中描述一个字段可以包含哪些信息。字段可以包括的修饰符有字段的作用域(public、private、protected修饰符）、是实例变量还是类变量(static修饰符）、可变性(final)、并发可见性(volatile修饰符，是否强制从主内存读写）、可否被序列化(transient修饰符）、字段数据类型（基本类型、对象、数组）、字段名称。

上述这些信息中，各个修饰符都是布尔值，要么有某个修饰符，要么没有，很适合使用标志位来表示。而字段叫做什么名字、字段被定义为什么数据类型，这些都是无法固定的，只能引用常量池中的常量来描述。

字段表结构：

![image-20200724154551938](http://img.fosuchao.com/image-20200724154551938.png)

字段访问标志：

![image-20200724154611456](http://img.fosuchao.com/image-20200724154611456.png)

## 方法表集合

如果理解了上一节关于字段表的内容，那本节关于方法表的内容将会变得很简单。CIass文件存储格式中对方法的描述与对字段的描述采用了几乎完全一致的方式，方法表的结构如同字段表一样，依次包括访问标志（access flags）、名称索引(name index)、描述符索引（descriptor index)、属性表集合（attributes）几项，如下图所示。

![image-20200724154819907](http://img.fosuchao.com/image-20200724154819907.png)

这些数据项目的含义也与字段表中的非常类似，仅在访问标志和属性表集合的可选项中有所区别。

## 属性表集合

属性表(attribute info)在前面的讲解之中已经出现过数次，CIass文件、字段表、方法表都可以携带自己的属性表集合，以描述某些场景专有的信息。

属性表结构：

![image-20200724155030073](http://img.fosuchao.com/image-20200724155030073.png)


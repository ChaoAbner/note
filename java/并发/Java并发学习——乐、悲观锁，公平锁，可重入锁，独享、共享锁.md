# java锁

![1575272581835](http://img.fosuchao.com/1575272581835.png)

## 乐观锁和悲观锁

​		从概念上说，**悲观锁在获取数据的时候会先加锁**，比如`synchronized`和`Lock`的实现类都是悲观锁。

​		乐观锁不会添加锁，而是在**更新数据时判断之前有没有其它线程修改了这个数据**。如果数据没有被更新，则将新数据写入。否则报错或者重试。乐观锁在Java中通过无锁编程来实现。最常采用**CAS算法**，Java原子类的递增就是使用这个算法。

![1575287285635](http://img.fosuchao.com/1575287285635.png)

可以发现

- 悲观锁适用于写操作较多的场合
- 乐观锁适用于读操作较多的场合

### CAS算法

![1575287371715](http://img.fosuchao.com/1575287371715.png)

​		只有当V等于A时，CAS才通过原子方式用新值B来更新V值。**“比较+更新”整体是一个原子操作。**一般情况下，“更新"是一个不断重复的操作。

​		CAS虽然很高效，但是存在三大问题：

![1575287947928](http://img.fosuchao.com/1575287947928.png)

## 自旋锁和适应性自旋锁

![1575288244669](http://img.fosuchao.com/1575288244669.png)

![1575288277499](http://img.fosuchao.com/1575288277499.png)

​		自旋并不能代替阻塞，如果线程需要等待的**时间较短，那么自旋会很适合**。反之自旋的线程会白白浪费处理器资源。

​		自旋锁的原理还是**CAS**，通过循环来执行自旋，直至修改成功。

​		自旋锁中另外三种常见的锁形式：**TicketLock**、**CLHlock**和**MCSlock**

## 无锁、偏向锁、轻量级锁和重量级锁

![1575288710675](http://img.fosuchao.com/1575288710675.png)

### Java对象头

​		像synchronized为同步资源加锁，这个锁就是存在于**Java对象头**里。

![1575288842751](http://img.fosuchao.com/1575288842751.png)

### Monitor

​		可以理解为一种同步机制或者同步工具，平时说每个Java对象都有一个对象锁，这个对象锁指的就是Monitor或者称为内部锁。

![1575289338033](http://img.fosuchao.com/1575289338033.png)

​		这个锁的状态有四种，级别从低到高分别是：

![1575289122615](http://img.fosuchao.com/1575289122615.png)

**无锁：**

![1575289180740](http://img.fosuchao.com/1575289180740.png)

**偏向锁：**

![1575289215124](http://img.fosuchao.com/1575289215124.png)

**轻量级锁：**

![1575289259261](http://img.fosuchao.com/1575289259261.png)

**重量级锁：**

![1575289292145](http://img.fosuchao.com/1575289292145.png)

## 公平锁和非公平锁

​		**公平锁**是指多个线程**按照申请锁的顺序来获取锁**。第一个线程获得锁，其它线程直接进入队列阻塞等待。保证等待的锁不会饿死，缺点是**吞吐量不如非公平锁高，等待队列除了第一次县城意外的所有线程都阻塞，CPU唤醒阻塞线程的开销比非公平锁大**。

​		非公平锁是**多个线程可以直接尝试获取锁，获取不到锁的线程才会进入等待队列等待**。优点是可以**减少唤起线程的开销，整体吞吐效率高，线程有几率不阻塞就能获取锁，CPU不必唤起所有线程**。缺点是**有些线程可能等待很久才能获取锁**。

![1575291238302](http://img.fosuchao.com/1575291238302.png)

## 可重入锁和非可重入锁

![1575291584076](http://img.fosuchao.com/1575291584076.png)

![1575292092958](http://img.fosuchao.com/1575292092958.png)

![1575292097886](http://img.fosuchao.com/1575292097886.png)

![1575292107954](http://img.fosuchao.com/1575292107954.png)

![1575292112526](http://img.fosuchao.com/1575292112526.png)

## 独享锁和共享锁

![1575292267584](http://img.fosuchao.com/1575292267584.png)


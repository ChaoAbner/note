## ping的原理

如果你想了解PING的原理，就看我的文章，不要去网上找，找不到什么好的内容。看了我文章，也许你会从对网络一窍不通，到豁然开朗。

先看拓朴图：

[![img](http://img1.51cto.com/attachment/201006/202221797.png)](http://img1.51cto.com/attachment/201006/202221797.png)

我在这里讲拼的两情况,一种是**同一网段**内,一种是**跨网段**的ping ….

 

首先，如果主机A，要去ping主机B，那么主机A，就要封装二层报文，他会先查自己的MAC地址表，如果没有B的MAC地址，就会向外发送一个**ARP广播包**，如图:

 

[![img](http://img1.51cto.com/attachment/201006/202245369.png)](http://img1.51cto.com/attachment/201006/202245369.png)

其中ARP报文格式如下:

| **以太网目的MAC** | **以太网源MAC**   | **帧类型** | **硬件类型** | **4** | **6**             | **OP**  | **发送端以太网MAC** | **发送端IP地址** | **目的MAC** | **目的IP** |
| ----------------- | ----------------- | ---------- | ------------ | ----- | ----------------- | ------- | ------------------- | ---------------- | ----------- | ---------- |
| FF-FF-FF-FF-FF-FF | 00-50-56-C0-00-01 | 0806       | 0800         | **1** | 00-50-56-C0-00-01 | 1.1.1.1 | 00-00-00-00-00-00   | 1.1.1.3          |             |            |

其中OP  

**1 :表示ARP请求**

**2:表示ARP应答**

**3:表示RARP请求**

**4:表示RARP应答**

- ARP：通过IP找MAC
- RARP：通过MAC找IP

　　首先,交换机会收到这个报文后，交换机有学习MAC地址的功能，所以他会检索自己有没有保存主机B有MAC，如果有，就返回给主机A，如果没有，就会向所有端口发送ARP广播，其它主机收到后，发现不是在找自己，就纷纷丢弃了该报文，不去理会。。直到主机B收到了报文后，就立即响应，我的MAC地址是多少，同时学到主机A的MAC地址,并按同样的ARP报文格式返回给主机A,如图:

 

[![img](http://img1.51cto.com/attachment/201006/202321234.png)](http://img1.51cto.com/attachment/201006/202321234.png)

ARP报文格式:

| **以太网目的MAC** | **以太网源MAC**   | **帧类型** | **硬件类型** | **4** | **6**             | **OP**  | **发送端以太网MAC** | **发送端IP地址** | **目的MAC** | **目的IP** |
| ----------------- | ----------------- | ---------- | ------------ | ----- | ----------------- | ------- | ------------------- | ---------------- | ----------- | ---------- |
| 00-50-56-C0-00-01 | 00-50-56-C0-00-03 | 0806       | 0800         | 2     | 00-50-56-C0-00-03 | 1.1.1.3 | 00-50-56-C0-00-01   | 1.1.1.1          |             |            |

​		这时候主机A学到了主机B的MAC，就把这个MAC封装到ICMP协议的二层报文中向主机B发送,报文格式如下：

| **目的地址**      | **源地址**        | **…**   | **源IP** | **目的IP**   | **…** | **ICMP报文** |
| ----------------- | ----------------- | ------- | -------- | ------------ | ----- | ------------ |
| 00-50-56-C0-00-03 | 00-50-56-C0-00-01 | 1.1.1.1 | 1.1.1.3  | Echo request |       |              |

​		当主机B收到了这个报文后，发现是主机A 的ICPM回显请求，就按同样的格式，返回一个值给主机A，这样就完成了同一网段内的ping过程…

| **目的地址**      | **源地址**        | **…**   | **源IP** | **目的IP**  | **…** | **ICMP报文** |
| ----------------- | ----------------- | ------- | -------- | ----------- | ----- | ------------ |
| 00-50-56-C0-00-01 | 00-50-56-C0-00-03 | 1.1.1.3 | 1.1.1.1  | Echo answer |       |              |

在这里，我讲了这么久的**局域网内的PING**,实际过程的发生不到**1毫秒….**

​       再继续…

​       如果主机A要ping主机C,那么主机A发现主机C的IP和自己不是同一网段,他就去找**网关**转发,但是他也不知道网关的MAC情况下呢?他就会向之前那个步骤一样**先发送一个ARP广播,学到网关的MAC,再发封装ICMP报文给网关路由器.**

报文格式如下:

| **目的地址**      | **源地址**        | **…**   | **源IP** | **目的IP**   | **…** | **ICMP报文** |
| ----------------- | ----------------- | ------- | -------- | ------------ | ----- | ------------ |
| 00-50-56-C0-00-02 | 00-50-56-C0-00-01 | 1.1.1.1 | 2.1.1.1  | Echo request |       |              |

　　　当路由器收到主机A发过来的ICMP报文,发现自己的目的地址是其本身MAC地址,根据目的的IP2.1.1.1,查路由表,发现2.1.1.1/24的路由表项,得到一个出口指针,去掉原来的MAC头部.加上自己的MAC地址向主机C转发…(**如果网关也没有主机C的MAC地址,还是要向前面一个步骤一样,ARP广播一下即可相互学到….路由器2端口能学到主机D的MAC,主机D也能学到路由器2端口的MAC.**.),报文格式如下:

| **目的地址**      | **源地址**        | **…**   | **源IP** | **目的IP**   | **…** | **ICMP报文** |
| ----------------- | ----------------- | ------- | -------- | ------------ | ----- | ------------ |
| 00-50-56-C0-00-05 | 00-50-56-C0-00-04 | 1.1.1.1 | 2.1.1.1  | Echo request |       |              |

　　　最后,在主机C已学到路由器2端口MAC,路由器2端口转发给路由器1端口,路由1端口学到主机A的MAC的情况下,他们就不需要再做ARP解析,就将ICMP的回显请求回复过来..报文格式大致如下:



| **目的地址**      | **源地址**        | **…**   | **源IP** | **目的IP**  | **…** | **ICMP报文** |
| ----------------- | ----------------- | ------- | -------- | ----------- | ----- | ------------ |
| 00-50-56-C0-00-04 | 00-50-56-C0-00-05 | 2.1.1.1 | 1.1.1.1  | Echo Answer |       |              |



### ping一个域名的过程

三、ping某个域名的整个过程



ICMP的一个重要应用就是分组网间探测PING（Packe InterNet Groper），用来测试主机之间的连通性。PING使用了ICMP回送请求与回送回答报文。PING是应用层直接使用网络层ICMP的一个例子，没有经过传输层的TCP或UDP。



ping某个域名相对于ping IP地址来说，多了一些步骤，主要用来获取域名对应的IP地址，整个过程如下：

1、主机查找**本地系统Hosts**文件的DNS缓存，如果存在该域名对应的IP，则获取IP，跳转到第8步；如果不存在，则继续。

2、主机向本网络路由器发起请求，查找路由DNS缓存，如果存在该域名对于的IP，则获取IP，跳转到第8步；如果不存在，则继续。

3、路由器向本地ISP（互联网提供商）的DNS服务器发起请求，查找DNS服务器的缓存，如果存在该域名对应的IP，则跳转到第7步；如果不存在，则继续。

4、本地DNS服务器向根域名服务器发起请求，根域名服务器告诉本地服务器，下一次应查询的顶级域名服务器dns.com的IP地址。

5、本地域名服务器向顶级域名服务器dns.com进行查询，顶级域名服务器dns.com告诉本地域名服务器，下一步应查询的权限服务器dns.abc.com的IP地址。

6、本地域名服务器向权限域名服务器dns.abc.com进行查询，权限域名服务器dns.abc.com告诉本地域名服务器，所查询的主机的IP地址。 

7、本地域名服务器最后把查询结果——该域名对应的IP地址告诉给主机。

8、至此，主机知道了该域名的IP地址。

![](https://img-blog.csdn.net/20160312163605736)



（以上部分主要是根据域名获取对应的IP地址，涉及DNS）

9、主机通过子网掩码判断该IP地址是本网段还是跨网段，由于本网段比较简单，我们以跨网段进行讲解。

10、主机先查看本地ARP高速缓存，查看表中是否有本网络路由器（网关）的MAC地址，如果有，则获取MAC地址，跳转到第12步；如果没有，则继续。

11、主机使用ARP解析协议获取到本网段路由的MAC地址。

12、至此，主机知道本网络一个路由的MAC地址。

---------------------------------（以上部分主要是获取本网络一个路由的MAC地址，涉及ARP）-----------------------------

13、主机将ICMP报文封装成IP数据报，IP数据报的源地址为主机的IP地址，目的地址是域名对应的IP地址；

14、主机将IP数据报封装成MAC帧，MAC帧的源地址为主机的MAC地址，目的地址是路由器的MAC地址；

12、路由器接收到ICMP报文之后，发现MAC帧的目的地址是自己，IP地址是主机想要访问的IP地址，则将MAC帧的源地址改为自己的MAC地址，目的地址改为本网段另一个路由的MAC地址（也要通过ARP协议获取），转发下去...

13、直到最后一个路由根据ARP协议，找到了主机想要访问的IP地址对应的主机的MAC地址，然后将ICMP报文封装成MAC帧发送给该域名主机。

14、由于ARP协议具有相互学习性，域名主机接收到主机发送的ICMP回送请求报文之后，将向本网络路由发送ICMP回送回答报文，该路由又会转发下去...

15、当主机收到域名主机发送的ICMP回送回答报文之后，这样就表明该主机到域名主机是连通可达的。

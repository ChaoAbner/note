## **1.本地过程：**

1. 若DNS缓存中没有相关数据，则IE浏览器先向DNS服务器发出DNS请求：
2. 这一过程的目的是获取wTCP长连接，短链接，双工，单工ww.sina.com这个域名所对应的IP地址；
3. IE浏览器向本机DNS模块发出DNS请求，DNS模块生成相关的DNS报文；
4. DNS模块将生成的DNS报文传递给传输层的UDP协议单元；
5. UDP协议单元将该数据封装成UDP数据报，传递给网络层的IP协议单元；
6. IP协议单元将该数据封装成IP数据包，其中目的IP地址为DNS服务器的IP地址；
7. 封装好的IP数据包将传递给数据链路层的协议单元进行发送；
8. 发送时如果ARP缓存中没有相关数据，则发送ARP广播请求，等待ARP回应；
9. 得到ARP回应后，将IP地址与路由下一跳MAC地址对应的信息写入ARP缓存表；
10. 写入缓存后，以路由下一跳地址填充目的MAC地址，并以数据帧形式转发；
11. 这个转发过程可能会进行多次，这取决于DNS服务器在校园网中的位置；
12. DNS请求被发送到DNS服务器的数据链路层协议单元；
13. DNS服务器的数据链路层协议单元解析收到的数据帧，将其内部所含有的IP数据包传递给网络层IP协议单元；
14. DNS服务器的IP协议单元解析收到的IP数据包，将其内部所含有的UDP数据报传递给传输层的UDP协议单元；
15. DNS服务器的UDP协议单元解析收到的UDP数据包，将其内部所含有的DNS报文传递给该服务器上的DNS服务单元；
16. DNS服务单元收到DNS请求，将域名解析为对应的IP地址，产生DNS回应报文；
17. （所有应用层报文必须通过传输层、网络层和数据链路层，因此在下面的叙述中，我将简化这一过程的叙述，简化形式如下面的样子，其中单箭头为本机内部传递，双箭头为网络上的发送）
18. DNS回应报文→UDP→IP→MAC→→请求域名解析的主机；
19. 请求域名解析的主机收到数据帧，该数据帧→IP→UDP→DNS→IE浏览器；
20. 将域名解析的结果以域名和IP地址对应的形式写入DNS缓存表。



## **2.IE浏览器与www.sina.com.cn建立TCP连接：TCP建立连接的三次握手**

1. IE浏览器向www.sina.com.cn发出TCP连接请求报文；
2. 该请求TCP报文中的SYN标志位被设置为1，表示连接请求；
3. 该TCP请求报文→IP(DNS)→MAC(ARP)→→校园网关→→www.sina.com.cn主机；
4. 该TCP请求报文经过IP层时，填入的目的IP地址就是上面DNS过程获得的IP地址；
5. 经过数据链路层时，若MAC地址不明，还要进行上面所叙述的ARP过程；
6. www.sina.com.cn收到的数据帧→IP→TCP，TCP协议单元会回应请求应答报文；
7. 该请求应答TCP报文中的SYN和ACK标志位均被设置为1，表示连接请求应答；
8. 该TCP请求应答报文→IP→MAC(ARP)→→校园网关→→请求主机；
9. 请求主机收到数据帧→IP→TCP，TCP协议单元会回应请求确认报文；
10. 该请求应答TCP报文中的ACK标志位被设置为1，表示连接请求确认；
11. 该TCP请求确认报文→IP→MAC(ARP)→→校园网关→→www.sina.com.cn主机；
12. www.sina.com.cn收到的数据帧→IP→TCP，连接建立完成；



**在这个过程中，任何一个报文出错或超时，都要进行重传；
这个过程被称为TCP建立连接的三次握手。**

## **3.IE浏览器开始HTTP访问过程**

1. IE浏览器向www.sina.com.cn发出HTTP-GET方法报文；
2. 该HTTP-GET方法报文→TCP→IP→MAC→→校园网关→→www.sina.com.cn主机；
3. www.sina.com.cn收到的数据帧→IP→TCP→HTTP，HTTP协议单元会回应HTTP协议格式封装好的HTML超文本形式数据；
4. HTTP-HTML数据→TCP→IP→MAC(ARP)→→校园网关→→请求主机；
5. 请求主机收到的数据帧→IP→TCP→HTTP→IE浏览器，浏览器会以网页形式显示HTML超文本，就是我们所看到的网页。



## **4.断开TCP连接：TCP断开连接的四次握手**

1. IE浏览器向www.sina.com.cn发出TCP连接结束请求报文；
2. 该请求TCP报文中的FIN标志位被设置为1，表示结束请求；
3. 该TCP结束请求报文→IP→MAC(ARP)→→校园网关→→www.sina.com.cn主机；
4. www.sina.com.cn收到的数据帧→IP→TCP，TCP协议单元会回应结束应答报文；
5. 该结束应答TCP报文中的FIN和ACK标志位均被设置为1，表示结束应答；
6. 该TCP结束应答报文→IP→MAC(ARP)→→校园网关→→请求主机；

这个过程需要双向进行，因此[www.sina.com.cn](http://www.sina.com.cn/)主机也会按上述流程再做一次；
整个过程被称为TCP断开连接的四次握手



# 1.您在浏览器的地址栏中输入maps.google.com。

# 2.浏览器在缓存中查找DNS记录，以找到maps.google.com的相应IP地址。

DNS（域名系统）是一个数据库，用于维护网站（URL）的名称及其链接到的特定IP地址。互联网上的每个URL都有一个唯一的IP地址。该IP地址属于托管我们请求访问的网站服务器的计算机。例如，[www.google.com](http://www.google.com/)的IP地址为209.85.227.104。因此，如果您愿意，可以在浏览器中输入[http://209.85.227.104](http://209.85.227.104/)来访问[www.google.com](http://www.google.com/)。DNS是URL及其IP地址的列表，例如电话簿是名称及其对应电话号码的列表。

DNS的主要目的是人性化的导航。您可以通过在浏览器中输入正确的IP地址来轻松访问该网站，但是想像一下，我们必须记住我们经常访问的所有网站的不同数字集吗？因此，更容易记住使用URL的网站名称，并让DNS通过将其映射到正确的IP为我们完成工作。

要查找DNS记录，浏览器将检查四个缓存。

●首先，它检查浏览器缓存。浏览器会为您以前访问的网站在固定期限内维护DNS记录的存储库。因此，它是第一个运行DNS查询的地方。

●其次，浏览器检查操作系统缓存。如果它不在浏览器缓存中，则浏览器将对您的基础计算机操作系统进行系统调用（即Windows上的*gethostname*）以获取记录，因为该操作系统还维护DNS记录的缓存。

●第三，检查路由器缓存。如果不在您的计算机上，则浏览器将与维护自己的DNS记录缓存的路由器通信。

●第四，检查ISP缓存。如果所有步骤失败，浏览器将继续使用ISP。您的ISP维护自己的DNS服务器，其中包括DNS记录的缓存，浏览器将检查该DNS记录，以期找到希望的URL。

您可能想知道为什么在这么多级别上维护了这么多缓存。尽管将我们的信息缓存在某个地方并不能使我们感到很舒服，但缓存对于调节网络流量和缩短数据传输时间至关重要。

# 3.如果请求的URL不在缓存中，则ISP的DNS服务器会发起DNS查询，以查找托管maps.google.com的服务器的IP地址。

如前所述，要使我的计算机与托管maps.google.com的服务器连接，我需要maps.google.com的IP地址。DNS查询的目的是在Internet上搜索多个DNS服务器，直到找到该网站的正确IP地址。这种搜索称为递归搜索，因为该搜索将反复从DNS服务器继续进行到DNS服务器，直到找到我们需要的IP地址或返回错误消息（表明找不到该地址）为止。

在这种情况下，我们将ISP的DNS服务器称为DNS递归器，其职责是通过向Internet上的其他DNS服务器询问答案来找到所需域名的正确IP地址。其他DNS服务器称为名称服务器，因为它们基于网站域名的域体系结构执行DNS搜索。

在不让您进一步困惑的情况下，我想使用下图说明域体系结构。

![image-20200701163040899](http://img.fosuchao.com/image-20200701163040899.png)

https://webhostinggeeks.com/guides/dns/

我们今天遇到的许多网站URL包含一个第三级域，一个第二级域和一个顶级域。这些级别中的每一个都包含自己的名称服务器，该名称服务器在DNS查找过程中进行查询。

对于maps.google.com，首先，DNS递归将与根名称服务器联系。根名称服务器会将其重定向到**.com**域名服务器。**.com**名称服务器会将其重定向到**google.com**名称服务器。在**google.com**域名服务器将在其DNS记录找到maps.google.com匹配的IP地址，并返回到你的DNS recursor，将其发送回浏览器。

这些请求是使用小型数据包发送的，这些数据包包含诸如请求的内容以及其发往的IP地址（DNS递归的IP地址）之类的信息。这些数据包在到达正确的DNS服务器之前，会通过客户端和服务器之间的多个网络设备传输。该设备使用路由表来确定哪种方法是数据包到达其目的地的最快方法。如果这些数据包丢失，您将收到请求失败错误。否则，它们将到达正确的DNS服务器，获取正确的IP地址，然后返回您的浏览器。

# 4.浏览器启动与服务器的TCP连接。

一旦浏览器收到正确的IP地址，它将与服务器建立一个与IP地址匹配的连接以传输信息。浏览器使用Internet协议建立此类连接。可以使用几种不同的Internet协议，但是TCP是用于许多类型的HTTP请求的最常见协议。

要在您的计算机（客户端）和服务器之间传输数据包，建立TCP连接非常重要。此连接是使用称为TCP / IP三向握手。这是一个三步过程，其中客户端和服务器交换SYN（同步）和ACK（确认）消息以建立连接。

1.客户端计算机通过Internet将SYN数据包发送到服务器，询问是否为新连接打开。

2.如果服务器具有开放的端口，可以接受并启动新的连接，它将使用SYN / ACK数据包以SYN数据包的确认应答。

3.客户端将从服务器接收SYN / ACK数据包，并通过发送ACK数据包进行确认。

然后建立一个TCP连接以进行数据传输！

# 5.浏览器将HTTP请求发送到Web服务器。

一旦建立了TCP连接，就该开始传输数据了！浏览器将发送GET请求，要求提供maps.google.com网页。如果您输入凭据或提交表单，则可能是POST请求。此请求还将包含其他信息，例如浏览器标识（*User-Agent*标头），它将接受的请求类型（*Accept*标头）以及要求其保持TCP连接活动以进行其他请求的连接标头。它还会传递从浏览器存储在该域中的cookie中获取的信息。

样本GET请求（标头突出显示）：

![img](https://miro.medium.com/max/60/0*SyxEqHOBZElX5laf.png?q=20)

![img](https://miro.medium.com/max/1485/0*SyxEqHOBZElX5laf.png)

（如果您对幕后发生的事情感到好奇，可以使用Firebug等工具查看HTTP请求。在我们不知情的情况下，查看客户端和服务器之间传递的信息总是很有趣的）。

# 6.服务器处理请求并发送回响应。

该服务器包含一个Web服务器（即Apache，IIS），该服务器从浏览器接收请求并将其传递给请求处理程序以读取并生成响应。请求处理程序是一个程序（用ASP.NET，PHP，Ruby等编写），用于读取请求，其标头和cookie，以检查请求的内容，并在需要时更新服务器上的信息。然后，它将以特定格式（JSON，XML，HTML）组合响应。

# 7.服务器发出HTTP响应。

服务器响应包含您请求的网页以及状态码，压缩类型（*Content-Encoding）*，如何缓存页面（*Cache-Control*），要设置的任何cookie，隐私信息等。

HTTP服务器响应示例：

![img](https://miro.medium.com/max/60/0*ifRt45gihG_AwR3Z.png?q=20)

![img](https://miro.medium.com/max/1628/0*ifRt45gihG_AwR3Z.png)

如果您查看以上响应，第一行将显示状态码。这很重要，因为它告诉我们响应的状态。使用数字代码可详细说明五种状态。

●1xx表示仅参考消息

●2xx表示某种成功

●3xx将客户端重定向到另一个URL

●4xx表示客户端错误

●5xx表示服务器方面的错误

因此，如果遇到错误，则可以查看HTTP响应以检查收到的状态码类型。

# 8.浏览器显示HTML内容（用于HTML响应，这是最常见的）。

浏览器会分阶段显示HTML内容。首先，它将渲染裸露的HTML骨架。然后，它将检查HTML标记并发出GET请求，以获取网页上其他元素的请求，例如图像，CSS样式表，JavaScript文件等。这些静态文件由浏览器缓存，因此不必提取它们下次您再次访问该页面时。最后，您会看到maps.google.com出现在浏览器中。

而已！

尽管这似乎是一个非常繁琐的冗长的过程，但我们知道在按键盘上的Enter键后，呈现网页所需的时间不到几秒钟。所有这些步骤都在几毫秒之内发生，我们甚至没有注意到。我衷心希望本文能帮助您回答以下问题：“在浏览器中键入URL并按Enter键会发生什么？”。
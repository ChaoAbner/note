# TCP的流量控制和拥塞控制

## 概念

​		拥塞：即对**资源的需求超过了可用的资源**。若网络中许多资源同时供应不足，网络的性能就要明显变坏，整个网络的吞吐量随之负荷的增大而下降。

​    拥塞控制：**防止过多的数据注入到网络中，这样可以使网络中的路由器或链路不致过载。**拥塞控制所要做的都有一个**前提：网络能够承受现有的网络负荷。**拥塞控制是一个**全局性的过程**，涉及到所有的主机、路由器，以及与降低网络传输性能有关的所有因素。

​    流量控制：指点对点通信量的控制，是端到端正的问题。流量控制所要做的就是**抑制发送端发送数据的速率**，以便使接收端来得及接收。



## 流量控制

1. 利用滑动窗口实现流量控制

​    如果发送方把数据发送得过快，接收方可能会来不及接收，这就会造成数据的丢失。所谓**流量控制**就是让发送方的发送速率不要太快，要让接收方来得及接收。

​    利用滑动窗口机制可以很方便地在TCP连接上实现对发送方的流量控制。

​    设A向B发送数据。在连接建立时，B告诉了A：“我的接收窗口是 rwnd = 400 ”(这里的 rwnd 表示 receiver window) 。因此，发送方的发送窗口不能超过接收方给出的接收窗口的数值。请注意，TCP的**窗口单位是字节**，不是报文段。TCP连接建立时的窗口协商过程在图中没有显示出来。再设每一个报文段为100字节长，而数据报文段序号的初始值设为1。大写ACK表示首部中的确认位ACK，小写ack表示确认字段的值ack。

![img](https://img-blog.csdn.net/20140509220855687?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveWVjaGFvZGVjaHVudGlhbg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

​    从图中可以看出，B进行了三次流量控制。第一次把窗口减少到 rwnd = 300 ，第二次又减到了 rwnd = 100 ，最后减到 rwnd = 0 ，即不允许发送方再发送数据了。这种使发送方暂停发送的状态将持续到主机B重新发出一个新的窗口值为止。B向A发送的三个报文段都设置了 ACK = 1 ，只有在ACK=1时确认号字段才有意义。

​    TCP为每一个连接设有一个持续计时器(persistence timer)。只要TCP连接的一方收到对方的零窗口通知，就启动持续计时器。若持续计时器设置的时间到期，就发送一个零窗口控测报文段（携1字节的数据），那么收到这个报文段的一方就重新设置持续计时器。



## 拥塞控制

计算机网络中的带宽、交换结点中的缓存及处理机等都是网络的资源。在某段时间，若对网络中某一资源的需求超过了该资源所能提供的可用部分，网络的性能就会变坏，这种情况就叫做拥塞。**拥塞控制就是防止过多的数据注入网络中，这样可以使网络中的路由器或链路不致过载**。注意，**拥塞控制和流量控制不同，前者是一个全局性的过程，而后者指点对点通信量的控制。**拥塞控制的方法主要有以下四种：

------

1). **慢开始（ slow-start）：**不要一开始就发送大量的数据，先探测一下网络的拥塞程度，也就是说**由小到大逐渐增加拥塞窗口的大小**;

​		发送方维持一个拥塞窗口 cwnd ( congestion window )的状态变量。**拥塞窗口的大小取决于网络的拥塞程度，并且动态地在变化**。发送方让自己的发送窗口等于拥塞。

------

2). **拥塞避免（congestion avoidance）：拥塞避免算法让拥塞窗口缓慢增长**，即每经过一个往返时间RTT就把发送方的**拥塞窗口cwnd加1**，而不是加倍，这样拥塞窗口按线性规律缓慢增长。

　　　　　　　　　　![慢开始与拥塞避免.png-90.3kB](http://static.zybuluo.com/Rico123/whi0y5sbc3tx9qcdp0s532gw/%E6%85%A2%E5%BC%80%E5%A7%8B%E4%B8%8E%E6%8B%A5%E5%A1%9E%E9%81%BF%E5%85%8D.png)

​		无论在慢开始阶段还是在拥塞避免阶段，只要发送方判断网络**出现拥塞**（其根据就是没有收到确认），就要把**慢开始门限ssthresh设置为出现拥塞时的发送方窗口值的一半**（但不能小于2）。然后把**拥塞窗口cwnd重新设置为1**，**执行慢开始算法**。这样做的目的就是要迅速减少主机发送到网络中的分组数，使得发生拥塞的路由器有足够时间把队列中积压的分组处理完毕。

------

3). **快重传（fast retransmit）：**快重传要求接收方在收到一个 **失序的报文段** 后就立即发出 **重复确认**（为的是使发送方及早知道有报文段没有到达对方）而不要等到自己发送数据时捎带确认。快重传算法规定，**发送方只要一连收到三个重复确认就应当立即重传对方尚未收到的报文段**，而不必继续等待设置的重传计时器时间到期。

　　　　　　　　　　![快重传.jpg-42.3kB](http://static.zybuluo.com/Rico123/wuktdms9jtg4s9m4pe5kcbiq/%E5%BF%AB%E9%87%8D%E4%BC%A0.jpg)

------

4). **快恢复（fast recovery）：**快重传配合使用的还有快恢复算法，当发送方连续收到三个重复确认时，就执行“**乘法减小**”算法，把ssthresh门限减半，但是接下去并不执行慢开始算法：因为如果网络出现拥塞的话就不会收到好几个重复的确认，所以发送方现在认为网络可能没有出现拥塞。所以此时**不执行慢开始算法，而是将cwnd设置为ssthresh的大小，然后执行拥塞避免算法。**![快恢复.jpg-52.9kB](http://static.zybuluo.com/Rico123/90am1vmd7408ef00mav8pfzk/%E5%BF%AB%E6%81%A2%E5%A4%8D.jpg)
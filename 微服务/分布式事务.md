# 分布式事务

## 跨库事务

订单库修改并提交成功，去库存库减库存的时候，数据库宕机了。这时就造成了问题。之前订单库已经提交了，没办法回滚。

解决方法：

- XA/JTA规范、两阶段提交协议（2PC）
- TCC

![](http://img.fosuchao.com/20200412102704.png)

### 两阶段提交

![1586616907107](F:\typoraImg\1586616907107.png)

**第一阶段**

引入一个协调者，订单库修改成功后，先将执行结果交给协调者。库存库修改成功，也将执行结果交给协调者。

**第二阶段**

如果有一个操作执行失败，则第二阶段都执行回滚操作。

如果多个操作都执行成功，第二阶段再让各个库进行提交事务。

**问题**

第一阶段成功，提交的时候有个别的库未提交成功？

解决：可以程序进行重试，如果重试次数达到了阈值，进行人工介入。

## 跨系统事务

跨系统事务通常发生在微服务架构下，微服务概述：

微服务是一种架构风格，一个大型复杂软件应用由一个或多个微服务组成。

系统中的各个微服务可被独立部署，各个微服务之间是松耦合的。

每个微服务内聚不同的业务模块。

**电商网站架构图**

![](http://img.fosuchao.com/20200412102556.png)

### 柔性事务

**CAP理论**
		开发大规模的分布式系统时会遇到三个特性：**一致性**（Consistency）、**可用性**（Availability）、**分区容错**（Partition-tolerance），而一个分布式系统最多只能满足其中的两项。
		分区容错性是分布式系统必然需要面对和解决的问题，因此系统架构师往往需要把精力花在如何根据业务特点在C（一致性）和A（可用性）之间寻求平衡。而前面我们提到的JTA 两阶段提交协议的分布式事务方案，强调的就是一致性；由于可用性较低，实际应用的并不多。

**BASE理论**

- 基本可用（Basically Available）
  指分布式系统在出现不可预知故障的时候，允许损失部分可用性。

- 软状态（ Soft State）
  指允许系统中的数据存在中间状态，并认为该中间状态的存在不会影响系统的整体可用性，即允许系统在不同节点的数据副本之间进行数据同步的过程存在延时。

- 最终一致（ Eventual Consistency）

  强调的是所有的数据更新操作，在经过一段时间的同步之后，最终都能够达到一个一致的状态。因此，最终一致性的本质是需要系统保证最终数据能够达到一致，而不需要实时保证系统数据的强一致性。

#### 最大努力通知方案

最简单的一种柔性事务，适用于一些最终一致性时间敏感度低的业务，且被动方处理结果不影响主动方的处理结果。典型的使用场景：如银行通知、商户通知等	

![](http://img.fosuchao.com/20200412103017.png)

#### TCC两阶段补偿型方案

**Try阶段**
		完成所有业务检查（一致性），预留业务资源(准隔离性)
		回顾上面航班预定案例的阶段1，机票就是业务资源，所有的资源提供者(航空公司)预留都成功，try阶段才算成功
**Confirm阶段**
	 	确认执行业务操作，不做任何业务检查， 只使用Try阶段预留的业务资源。回顾上面航班预定案例的阶段2，美团APP确认两个航空公司机票都预留成功，因此向两个航空公司分别发送确认购买的请求。
**Cancel阶段**
		 取消Try阶段预留的业务资源。回顾上面航班预定案例的阶段2，如果某个业务方的业务资源没有预留成功，则取消所有业务资源预留请求。 

#### TCC与XA/JTA对比

-  XA是资源层面的分布式事务，强一致性，在两阶段提交的整个过程中，一直会持有资源的锁。

-  TCC是业务层面的分布式事务，最终一致性，不会一直持有资源的锁。

- TCC的开源框架实现

  Atomikos，tcc-transaction，spring-cloud-rest-tcc，支付宝tcc

### 可靠消息最终一致性方案

#### 基于Rocket MQ

![](http://img.fosuchao.com/20200412103230.png)

#### 基于普通的消息队列中间件

![](http://img.fosuchao.com/20200412103332.png)
参考：https://zhuanlan.zhihu.com/p/42929114

当我们提交了一些不希望的代码，需要做一下代码回滚。

或者当我们的项目上线之后，出现了紧急bug，为了保证线上稳定运行，那么也需要我们会滚到之前的版本。

通常我们的代码回滚分成两种场景：

- 已提交但是没有push到远程仓库
- 已经交并且push到远程仓库
- push到了远程仓库，并且已经合并到主仓库



## 已提交但是没有push到远程仓库

对于已提交但是没有push到远程仓库的情况，我们想要回退版本，这种操作称为撤销。

通常我们进行版本回退需要进行三个步骤：

1. 查看版本信息，确认回退版本id
2. 回退版本
3. 重新push到远程仓库

### 查看版本信息

我们在git命令行可以通过`git log`命令去查看分支提交的历史，确认我们需要回退的版本。

![image-20201125100338418](http://img.fosuchao.com/image-20201125100338418.png)

当前HEAD指向的就是我们当前版本

### 版本回退

比如我们要回退到上一个版本，即

![image-20201125101636201](http://img.fosuchao.com/image-20201125101636201.png)

可以输入命令

```git
# 回退到上一个版本
git reset --hard HEAD^
# 回退到指定版本
git reset --hard commit_id(1eb04ee...)
```

> HEAD是指向当前版本的指针，HEAD^表示上个版本,HEAD^^表示上上个版本

reset后面的参数主要有几种,，默认参数为--mixed。

![image-20201125101924004](http://img.fosuchao.com/image-20201125101924004.png)

- --soft：这个版本的命令有“最小”影响，只改变一个符号引用的状态使其指向一个新提交，不会改变其索引和工作目录
- --hard：本地版本库的头指针全部重置到了指定版本，暂存区也会被重置，工作区的代码也会回退
- --mixed：会保留提交的源码改动，只是将索引信息回退到了某一个版本，如果还需要继续提交，再次执行 `git add` 和 `git commit`

如果修改到的文件比较少，我们可以不通过命令回滚的方式，手动删除之前的修改，再进行提交。

**撤销暂存区中的修改**

如果我们想撤销暂存区中的文件内容（即执行了git add命令之后的文件），我们可以使用`git reset HEAD file_name` 命令即可撤销。

例：

使用`git add 1.txt`添加1.txt到暂存区

![image-20201125103840920](http://img.fosuchao.com/image-20201125103840920.png)



`git reset HEAD 1.txt` 撤销1.txt

![image-20201125103822130](http://img.fosuchao.com/image-20201125103822130.png)

## 已经交并且push到远程仓库

对于已经交并且push到远程仓库的代码，如果我们需要进行回滚，那么这种操作叫做回滚。

而回滚操作，我们使用的是`revert`命令。

我们在本地进行提交1.txt后，并且push到远程仓库

![image-20201125110023479](http://img.fosuchao.com/image-20201125110023479.png)

执行回滚命令

```git
# 撤销最近的一次提交
git revert HEAD --no-edit
```

![image-20201125105843715](http://img.fosuchao.com/image-20201125105843715.png)

可以看到我们想要回滚的版本是`14a69f2`，在执行完命令之后，发现这个版本还在，并且多了一个id为`2ba222c`的提交。

因此可以看出，`git revert`是对给定的commit提交进行逆过程的操作，然后消除给定的提交的影响。revert命令不修改版本库的现存历史记录，相反它只会在记录添加新的提交。


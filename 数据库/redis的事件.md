# Redis的事件

Redis是一个事件驱动型的程序。Redis服务器会产生两类事件。

- 文件事件（file event）

  Redis通过套接字与客户端进行连接。而文件事件就是Redis对套接字操作的抽象。Redis服务器与客户端之间的通信会产生一些事件，服务器则监听并处理这些事件完成一系列的网络通信操作。

- 时间事件（time event）

  Redis中的一些操作（如serverCron函数）需要在给定的时间点执行，而时间事件就是服务器对这类定时操作的抽象。

## 文件事件

Redis基于Reactor模式开发了自己的网络事件处理器：这个处理器被称为**文件事件处理器**

- 文件事件处理器使用I/O多路复用程序来同时监听多个套接字，并
  根据套接字目前执行的任务来为套接字关联不同的事件处理器。

- 当被监听的套接字准备好执行连接应答（accept）、读取（read）、写人（write）、关
  闭（close）等操作时，与操作相对应的文件事件就会产生，这时文件事件处理器就
  会调用套接字之前关联好的事件处理器来处理这些事件。

虽然**文件事件处理器**以**单线程**方式运行，但通过使用**I/O多路复用程序来监听多个套接**
**字**，文件事件处理器既实现了高性能的网络通信模型，又可以很好地与Redis服务器中其他
同样以单线程方式运行的模块进行对接，这保持了Redis内部单线程设计的简单性。

### 文件事件处理器

#### 构成

文件事件处理器由四个组成部分，套接字，I/O多路复用程序，文件事件分发器（dispatcher），事件处理器。

![](http://img.fosuchao.com/20200522172250.png)

#### 原理

文件事件是对套接字操作的抽象，每当一个套接字准备好执行连接应答（accept）、写人、读取、关闭等操作时，就会产生一个文件事件。因为一个服务器通常会连接多个套接字，所以多个文件事件有可能会并发地出现。

I/O多路复用程序负责监听多个套接字，并向文件事件分派器传送那些产生了事件的套接字。

尽管多个文件事件可能会并发地出现，但**I/O多路复用程序**总是会将所有产生事件的**套接字**都放到一**个队列**里面，然后通过这个队列，以**有序**（sequentially）、**同步**（synchronously）、每次一个套接字的方式向文件事件分派器传送套接字。当上一个套接字产生的事件被处理完毕之后（该套接字为事件所关联的事件处理器执行完毕)，I/O多路复用程序才会继续向文件事件分派器传送下一个套接字，如下图所示。

![](http://img.fosuchao.com/20200522172610.png)

#### 分类

**连接应答处理器**

当Redis服务器进行**初始化的时候**，程序会将这个**连接应答处理器和服务器监听套接字**的`AE_READABLE`事件关联起来，当有客户端用`sys/socket.h/connect`函数连接服务器监听套接字的时候，套接字就会产生`AE_READABLE`事件，引发连接应答处理器执行，并执行相应的套接字应答操作。

**命令请求处理器**

当一个客户端通过**连接应答处理器成功连接到服务器**之后，服务器会将**客户端套接字的事件和命令请求处理器关联起来**，当客户端向服务器发送命令请求的时候，套接字就会产生AE事件，引发命令请求处理器执行，并执行相应的套接字读操作。

客户端连接服务器的整个过程中。服务器都会一直为客户端套接字的`AE_READABLE`事件关联命令请求处理器。

**命令回复处理器**

当服务器有**命令回复需要传送给客户端**的时候，服务器会将**客户端套接字的事件和命令回复处理器关联起来**，当客户端准备好接收服务器传回的命令回复时，就会产生`AE_WRITABLE`事件，引发命令回复处理器执行，并执行相应的套接字**写入**操作。

服务器与客户端通信的整个过程如下图

![](http://img.fosuchao.com/20200522173655.png)

## 时间事件

Redis的时间事件分为以下两类：

- **定时事件**：让一段程序在指定的时间之后执行一次。比如说，让程序X在当前时间的30毫秒之后执行一次。

- **周期性事件**：让一段程序每隔指定时间就执行一次。比如说，让程序Y每隔30毫秒就执行一次。

一个时间事件主要由以下三个属性组成：

- id：服务器为时间事件创建的全局唯一ID（标识号）。ID号按从小到大的顺序递增，新事件的ID号比旧事件的ID号要大。

- when:毫秒精度的时间戳，记录了时间事件的到达（arrive）时间。

- timeProc：时间事件处理器，一个函数。当时间事件到达时，服务器就会调用相应的处理器来处理事件。

### 实现

Redis将所有的时间事件都放在一个无序链表中。每当时间事件执行器运行时，它就会遍历整个链表，检查到达执行时间的时间事件。并进行执行处理。

链表按id逆序排序，但是时间是无序的。

![](http://img.fosuchao.com/20200522174037.png)

**性能问题**

很多人可能会想，无序链表的遍历不会造成效率问题吗？为什么不直接按照时间来排序呢，将时间小的排在前面，那么直到遍历到未来的时间（未达到执行时间）的时候就可以不遍历了。

其实这里的无序链表并不会影响性能。

在目前版本中，正常模式下的Redis服务器只使用`servercron`一个时间事件，而在benchmark模式下，服务器也只使用两个时间事件。在这种情况下，服务器几乎是将无序裢表退化成一个指针来使用，所以使用无序撻表来保存时间事件，并不影响事件执行的性能。

### serverCron函数

持续运行的Redis服务器需要定期对自身的资源和状态进行检查和调整，从而确保服务器可以长期、稳定地运行，这些定期操作由redis.c/servercron函数负责执行，它的主要工作包括：

- 更新服务器的各类统计信息，比如时间、内存占用、数据库占用情况等。

- 清理数据库中的过期键值对。

- 关闭和清理连接失效的客户端。

- 尝试进行AOF或RDB持久化操作。

- 如果服务器是主服务器，那么对从服务器进行定期同步。

- 如果处于集群模式，对集群进行定期同步和连接测试。

Redis服务器以**周期性**事件的方式来运行`servercron`函数，在服务器运行期间，每隔一段时间，servercron就会执行一次，直到服务器关闭为止。

## 事件的调度和执行

服务器有文件事件和时间事件这两种事件，因为Redis是单线程的程序，那么这些事件就避免不了调度的问题。

服务器运行的流程可以用下面的流程图来概括。

![](http://img.fosuchao.com/20200522174743.png)

#### 事件的调度和执行规则

1）`aeApiPoll`函数的最大阻塞时间由到达时间最接近当前时间的时间事件决定，这个方法既可以避免服务器对时间事件进行频繁的轮询（忙等待),也可以确保`aeApiPoll`函数不会阻塞过长时间。

2）因为文件事件是随机出现的，如果等待并处理完一次文件事件之后，仍未有任何时间事件到达，那么服务器将再次等待并处理文件事件。随着文件事件的不断执行，时间会逐渐向时间事件所设置的到达时间逼近，并最终来到到达时间，这时服务器就可以开始处理到达的时间事件了。

3）对文件事件和时间事件的处理都是**同步、有序、原子**地执行的，服务器不会中途中断事件处理，也不会对事件进行抢占，因此，不管是文件事件的处理器，还是时间事件的处理器，它们都会尽可地减少程序的阻塞时间，并在有需要时主动让出执行权，从而降低造成事件饥饿的可能性。比如说，在命令回复处理器将一个命令回复写人到客户端套接字时，如果写人字节数超过了一个预设常量的话，命令回复处理器就会主动用break跳出写入循环，将余下的数据留到下次再写；另外，时间事件也会将非常耗时的持久化操作放到子线程或者子进程执行。

4）因为时间事件在文件事件后面执行。并且事件不会发生抢占。所以时间事件的实际执行时间会晚于事件设定的到达时间。

## 重点回顾

- Redis服务器是一个事件驱动程序，服务器处理的事件分为时间事件和文件事件两类。

- 文件事件处理器是基于Reactor模式实现的网络通信程序。

- 文件事件是对套接字操作的抽象：每次套接字变为可应答（acceptable）、可写（writeable）或者可读（readable）时，相应的文件事件就会产生。

- 文件事件分为AE_READABLE事件（读事件）和AE_WRITEABLE事件（写事件）两类。

- 时间事件分为定时事件和周期性事件：定时事件只在指定的时间到达一次，而周期性事件则每隔一段时间到达一次。

- 服务器在一般情况下只执行servercron函数一个时间事件，并且这个事件是周期性事件。

- 文件事件和时间事件之间是合作关系，服务器会轮流处理这两种事件，并且处理事件的过程中也不会进行抢占。

- 时间事件的实际处理时间通常会比设定的到达时间晚一些。